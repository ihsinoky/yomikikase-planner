<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èª­ã¿èã‹ã›ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      padding: 16px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    h1 {
      font-size: 24px;
      margin-bottom: 16px;
      color: #06c755;
    }
    
    .status {
      padding: 12px;
      background-color: #e8f5e9;
      border-left: 4px solid #4caf50;
      border-radius: 4px;
      margin-bottom: 24px;
    }
    
    .status.loading {
      background-color: #fff3e0;
      border-left-color: #ff9800;
    }
    
    .status.error {
      background-color: #ffebee;
      border-left-color: #f44336;
    }
    
    .info-section {
      margin-bottom: 24px;
    }
    
    .info-section h2 {
      font-size: 18px;
      margin-bottom: 12px;
      color: #555;
    }
    
    .info-section p {
      margin-bottom: 8px;
      color: #666;
    }
    
    .footer {
      margin-top: 32px;
      padding-top: 16px;
      border-top: 1px solid #e0e0e0;
      text-align: center;
      color: #999;
      font-size: 14px;
    }
  </style>
  <!-- LIFF SDK (CDN) - pinned to version 2.23.1 for stability -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/2.23.1/sdk.js"></script>
</head>
<body>
  <div class="container">
    <h1>ğŸ“š èª­ã¿èã‹ã›ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼</h1>
    
    <div id="status" class="status loading">
      èª­ã¿è¾¼ã¿ä¸­...
    </div>
    
    <div class="info-section">
      <h2>ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±</h2>
      <p>ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€å¹¼ç¨šåœ’ã®èª­ã¿èã‹ã›æ´»å‹•ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã® LINE ãƒŸãƒ‹ã‚¢ãƒ—ãƒªã§ã™ã€‚</p>
      <p><strong>ç¾åœ¨ã®çŠ¶æ…‹:</strong> Sprint 1 - LIFFåˆæœŸè¡¨ç¤ºï¼‹ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè£…</p>
    </div>
    
    <div class="footer">
      <p>yomikikase-planner v1.0.0</p>
      <p>Powered by Google Apps Script</p>
    </div>
  </div>

  <script>
    // Sprint 1: LIFF åˆæœŸåŒ–ã¨ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè£…
    document.addEventListener('DOMContentLoaded', async function() {
      const statusEl = document.getElementById('status');
      
      // LIFF ãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
      if (typeof liff === 'undefined') {
        statusEl.className = 'status error';
        statusEl.textContent = 'âœ— LIFF SDK ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“';
        addDebugInfo('ç’°å¢ƒ', 'LIFF SDK æœªèª­ã¿è¾¼ã¿');
        return;
      }
      
      try {
        // LIFF ID ã‚’å–å¾—ï¼ˆGAS ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚µãƒ¼ãƒ“ã‚¹ã¾ãŸã¯ç’°å¢ƒå¤‰æ•°ã‹ã‚‰è¨­å®šã™ã‚‹ã“ã¨ã‚’æƒ³å®šï¼‰
        // Sprint 1ã§ã¯ã€ã¾ãšãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã¾ãŸã¯ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ LIFF ID ã‚’å—ã‘å–ã‚‹
        const urlParams = new URLSearchParams(window.location.search);
        const liffId = urlParams.get('liffId') || 'YOUR-LIFF-ID-HERE';
        
        if (liffId === 'YOUR-LIFF-ID-HERE') {
          statusEl.className = 'status';
          statusEl.textContent = 'â„¹ LIFF ID ãŒæœªè¨­å®šã§ã™ã€‚URLã« ?liffId=YOUR_LIFF_ID ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚';
          addDebugInfo('ç’°å¢ƒ', 'LIFF ID æœªè¨­å®š');
          addDebugInfo('ãƒ’ãƒ³ãƒˆ', 'URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: ?liffId=YOUR_LIFF_ID');
          
          // LIFF ID ãªã—ã§ã‚‚ health ãƒã‚§ãƒƒã‚¯ã¯å®Ÿè¡Œ
          await checkHealth();
          return;
        }
        
        statusEl.textContent = 'LIFF ã‚’åˆæœŸåŒ–ä¸­...';
        // LIFF ID ã®é•·ã•ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã‹ã‚‰è¡¨ç¤º
        const liffIdDisplay = liffId.length > 10 ? liffId.substring(0, 10) + '...' : liffId;
        addDebugInfo('LIFF ID', liffIdDisplay);
        
        // LIFF åˆæœŸåŒ–
        await liff.init({ liffId: liffId });
        
        // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
        if (!liff.isLoggedIn()) {
          statusEl.className = 'status';
          statusEl.textContent = 'æœªãƒ­ã‚°ã‚¤ãƒ³ - ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™...';
          addDebugInfo('çŠ¶æ…‹', 'æœªãƒ­ã‚°ã‚¤ãƒ³ï¼ˆå¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã¾ãŸã¯åˆå›èµ·å‹•ï¼‰');
          
          // å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶å¯¾ç­–: login() ã‚’å‘¼ã¶
          setTimeout(() => {
            liff.login();
          }, 2000);
          return;
        }
        
        // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ - ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’å–å¾—
        statusEl.className = 'status';
        statusEl.textContent = 'âœ“ LIFF ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ';
        
        const profile = await liff.getProfile();
        addDebugInfo('ãƒ¦ãƒ¼ã‚¶ãƒ¼ID', profile.userId);
        addDebugInfo('è¡¨ç¤ºå', profile.displayName || '(æœªè¨­å®š)');
        addDebugInfo('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ', profile.pictureUrl ? 'ã‚ã‚Š' : 'ãªã—');
        
        // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’è¿½åŠ 
        const context = liff.getContext();
        if (context) {
          addDebugInfo('èµ·å‹•å…ƒ', context.type || 'unknown');
        }
        
        // OSæƒ…å ±
        addDebugInfo('OS', liff.getOS());
        
        // LINE ãƒãƒ¼ã‚¸ãƒ§ãƒ³
        const lineVersion = liff.getLineVersion();
        if (lineVersion) {
          addDebugInfo('LINE ãƒãƒ¼ã‚¸ãƒ§ãƒ³', lineVersion);
        }
        
        // å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã©ã†ã‹
        addDebugInfo('å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶', liff.isInClient() ? 'ã„ã„ãˆï¼ˆLINEã‚¢ãƒ—ãƒªå†…ï¼‰' : 'ã¯ã„');
        
        // ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯API ã‚’å®Ÿè¡Œ
        await checkHealth();
        
      } catch (err) {
        statusEl.className = 'status error';
        statusEl.textContent = 'âœ— LIFF åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + err.message;
        addDebugInfo('ã‚¨ãƒ©ãƒ¼è©³ç´°', err.toString());
        console.error('LIFF initialization error:', err);
      }
    });
    
    // ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ API ã‚’å‘¼ã³å‡ºã™
    async function checkHealth() {
      try {
        const baseUrl = window.location.href.split('?')[0];
        const healthUrl = baseUrl + '?action=health';
        
        addDebugInfo('ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯URL', healthUrl);
        
        const response = await fetch(healthUrl);
        
        // HTTP ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
        if (!response.ok) {
          addDebugInfo('GAS Health', 'âœ— HTTPã‚¨ãƒ©ãƒ¼: ' + response.status);
          return;
        }
        
        const data = await response.json();
        
        if (data.ok) {
          addDebugInfo('GAS Health', 'âœ“ OK - ' + data.message);
          addDebugInfo('ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—', data.timestamp);
        } else {
          addDebugInfo('GAS Health', 'âœ— å¤±æ•—');
        }
      } catch (err) {
        addDebugInfo('GAS Health', 'âœ— ã‚¨ãƒ©ãƒ¼: ' + err.message);
        console.error('Health check error:', err);
      }
    }
    
    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ãƒšãƒ¼ã‚¸ã«è¿½åŠ 
    function addDebugInfo(label, value) {
      const container = document.querySelector('.container');
      
      // ãƒ‡ãƒãƒƒã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
      let debugSection = document.getElementById('debug-section');
      if (!debugSection) {
        debugSection = document.createElement('div');
        debugSection.id = 'debug-section';
        debugSection.className = 'info-section';
        debugSection.innerHTML = '<h2>ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h2><div id="debug-items"></div>';
        
        // ãƒ•ãƒƒã‚¿ãƒ¼ã®å‰ã«æŒ¿å…¥
        const footer = document.querySelector('.footer');
        container.insertBefore(debugSection, footer);
      }
      
      const debugItems = document.getElementById('debug-items');
      const item = document.createElement('p');
      item.innerHTML = '<strong>' + escapeHtml(label) + ':</strong> ' + escapeHtml(value);
      debugItems.appendChild(item);
    }
    
    // HTML ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(text) {
      // null/undefined ãƒã‚§ãƒƒã‚¯
      if (text == null) {
        return '';
      }
      // æ–‡å­—åˆ—ã«å¤‰æ›
      const str = String(text);
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
  </script>
</body>
</html>
