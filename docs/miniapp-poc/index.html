<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LIFF PoC - èª­ã¿èã‹ã›ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      padding: 16px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    h1 {
      font-size: 24px;
      margin-bottom: 16px;
      color: #06c755;
    }
    
    .status {
      padding: 12px;
      background-color: #e8f5e9;
      border-left: 4px solid #4caf50;
      border-radius: 4px;
      margin-bottom: 24px;
    }
    
    .status.loading {
      background-color: #fff3e0;
      border-left-color: #ff9800;
    }
    
    .status.error {
      background-color: #ffebee;
      border-left-color: #f44336;
    }
    
    .info-section {
      margin-bottom: 24px;
      padding: 16px;
      background-color: #f9f9f9;
      border-radius: 4px;
    }
    
    .info-section h2 {
      font-size: 18px;
      margin-bottom: 12px;
      color: #555;
    }
    
    .info-section p {
      margin-bottom: 8px;
      color: #666;
      word-break: break-all;
    }
    
    .footer {
      margin-top: 32px;
      padding-top: 16px;
      border-top: 1px solid #e0e0e0;
      text-align: center;
      color: #999;
      font-size: 14px;
    }
    
    .log-entry {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      padding: 4px 0;
      border-bottom: 1px solid #eee;
    }
    
    .log-entry:last-child {
      border-bottom: none;
    }
    
    .log-timestamp {
      color: #999;
      margin-right: 8px;
    }
    
    .log-level {
      font-weight: bold;
      margin-right: 8px;
    }
    
    .log-level.info {
      color: #2196f3;
    }
    
    .log-level.success {
      color: #4caf50;
    }
    
    .log-level.error {
      color: #f44336;
    }
    
    .log-level.warn {
      color: #ff9800;
    }
  </style>
  <!-- LIFF SDK (CDN edge) -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div class="container">
    <h1>ğŸ“š LIFF PoC - èª­ã¿èã‹ã›ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼</h1>
    
    <div id="status" class="status loading">
      åˆæœŸåŒ–ä¸­...
    </div>
    
    <div class="info-section">
      <h2>â„¹ï¸ ã“ã®ãƒšãƒ¼ã‚¸ã«ã¤ã„ã¦</h2>
      <p>GitHub Pages ã§é…ä¿¡ã•ã‚Œã‚‹é™çš„ LIFF ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã® PoC ã§ã™ã€‚</p>
      <p><strong>ç›®çš„:</strong> liff.init() ã¨ liff.getProfile() ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª</p>
    </div>
    
    <div id="debug-section" class="info-section">
      <h2>ğŸ” ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</h2>
      <div id="debug-logs"></div>
    </div>
    
    <div class="footer">
      <p>yomikikase-planner GitHub Pages PoC</p>
      <p>Powered by LIFF SDK</p>
    </div>
  </div>

  <script>
    // å®šæ•°å®šç¾©
    const LOGIN_REDIRECT_DELAY_MS = 2000; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã‚€æ™‚é–“ã‚’ç¢ºä¿
    const LIFF_ID_PATTERN = /^\d{10}-[a-zA-Z0-9]{8,}$/; // LIFF ID ã®å½¢å¼: 10æ¡ã®æ•°å­— - 8æ–‡å­—ä»¥ä¸Šã®è‹±æ•°å­—
    const ALLOWED_LOG_LEVELS = ['info', 'success', 'error', 'warn']; // log() é–¢æ•°ã§è¨±å¯ã•ã‚Œã‚‹ãƒ¬ãƒ™ãƒ«
    const ALLOWED_STATUS_TYPES = ['loading', 'error', 'success']; // updateStatus() é–¢æ•°ã§è¨±å¯ã•ã‚Œã‚‹ã‚¿ã‚¤ãƒ—
    
    // ãƒ­ã‚°å‡ºåŠ›ç”¨ã®é–¢æ•°
    function log(level, message) {
      // level ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆCSS class injection é˜²æ­¢ï¼‰
      const safeLevel = ALLOWED_LOG_LEVELS.includes(level) ? level : 'info';
      
      const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
      const logContainer = document.getElementById('debug-logs');
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `<span class="log-timestamp">${timestamp}</span><span class="log-level ${safeLevel}">[${safeLevel.toUpperCase()}]</span>${escapeHtml(message)}`;
      logContainer.appendChild(entry);
      
      // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›
      console.log(`[${safeLevel.toUpperCase()}] ${message}`);
      
      // æœ€æ–°ã®ãƒ­ã‚°ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      entry.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    function logInfo(message) {
      log('info', message);
    }
    
    function logSuccess(message) {
      log('success', message);
    }
    
    function logError(message) {
      log('error', message);
    }
    
    function logWarn(message) {
      log('warn', message);
    }
    
    // HTML ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
    function escapeHtml(text) {
      if (text === null || text === undefined) {
        return '';
      }
      const str = String(text);
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°é–¢æ•°
    function updateStatus(text, type = 'loading') {
      // type ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆCSS class injection é˜²æ­¢ï¼‰
      const safeType = ALLOWED_STATUS_TYPES.includes(type) ? type : 'loading';
      
      const statusEl = document.getElementById('status');
      statusEl.textContent = text;
      statusEl.className = `status ${safeType}`;
    }
    
    // LIFF ID ã®å–å¾—ï¼ˆURL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
    function getLiffId() {
      const urlParams = new URLSearchParams(window.location.search);
      const liffId = urlParams.get('liffId');
      
      if (!liffId) {
        logWarn('LIFF ID ãŒ URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«æŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        logInfo('ä½¿ç”¨æ–¹æ³•: ?liffId=YOUR_LIFF_ID ã‚’ URL ã«è¿½åŠ ã—ã¦ãã ã•ã„');
        return null;
      }
      
      // LIFF ID ã®å½¢å¼ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!LIFF_ID_PATTERN.test(liffId)) {
        logError('ç„¡åŠ¹ãª LIFF ID å½¢å¼ã§ã™ï¼ˆæ­£ã—ã„å½¢å¼: 1234567890-abcdefghï¼‰');
        return null;
      }
      
      return liffId;
    }
    
    // ãƒ¡ã‚¤ãƒ³å‡¦ç†
    async function main() {
      try {
        logInfo('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
        logInfo('LIFF SDK ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ' + (liff.version || 'unknown'));
        
        // LIFF ID ã®å–å¾—
        const liffId = getLiffId();
        if (!liffId) {
          updateStatus('âŒ LIFF ID ãŒæœªè¨­å®šã§ã™', 'error');
          logError('LIFF ID ã‚’ URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æŒ‡å®šã—ã¦ãã ã•ã„: ?liffId=YOUR_LIFF_ID');
          return;
        }
        
        logInfo('LIFF ID: ' + liffId.substring(0, 10) + '...');
        
        // ç¾åœ¨ã® URL ã‚’è¡¨ç¤º
        logInfo('ç¾åœ¨ã® URL: ' + window.location.href);
        
        // LIFF åˆæœŸåŒ–
        updateStatus('LIFF ã‚’åˆæœŸåŒ–ä¸­...', 'loading');
        logInfo('liff.init() ã‚’å‘¼ã³å‡ºã—ä¸­...');
        
        await liff.init({
          liffId: liffId,
          withLoginOnExternalBrowser: true
        });
        
        logSuccess('âœ… liff.init() ãŒæˆåŠŸã—ã¾ã—ãŸ');
        
        // ç’°å¢ƒæƒ…å ±ã®å–å¾—
        const isInClient = liff.isInClient();
        const isLoggedIn = liff.isLoggedIn();
        const os = liff.getOS();
        const language = liff.getLanguage();
        const version = liff.getVersion();
        const lineVersion = liff.getLineVersion();
        
        logInfo('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
        logInfo('ğŸ“± ç’°å¢ƒæƒ…å ±');
        logInfo('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
        logInfo('isInClient: ' + isInClient + (isInClient ? ' (LINEã‚¢ãƒ—ãƒªå†…)' : ' (å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶)'));
        logInfo('isLoggedIn: ' + isLoggedIn);
        logInfo('OS: ' + os);
        logInfo('Language: ' + language);
        logInfo('LIFF Version: ' + version);
        if (lineVersion) {
          logInfo('LINE Version: ' + lineVersion);
        }
        
        // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±
        const context = liff.getContext();
        if (context) {
          logInfo('Context Type: ' + (context.type || 'unknown'));
          logInfo('Context viewType: ' + (context.viewType || 'unknown'));
        }
        
        // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ãƒã‚§ãƒƒã‚¯
        if (!isLoggedIn) {
          updateStatus('æœªãƒ­ã‚°ã‚¤ãƒ³ - ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ', 'loading');
          logWarn('æœªãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã§ã™');
          logInfo(`${LOGIN_REDIRECT_DELAY_MS / 1000}ç§’å¾Œã« liff.login() ã‚’å®Ÿè¡Œã—ã¾ã™...`);
          
          setTimeout(() => {
            logInfo('liff.login() ã‚’å‘¼ã³å‡ºã—ä¸­...');
            liff.login();
          }, LOGIN_REDIRECT_DELAY_MS);
          return;
        }
        
        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã®å–å¾—
        logInfo('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
        logInfo('ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—');
        logInfo('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
        logInfo('liff.getProfile() ã‚’å‘¼ã³å‡ºã—ä¸­...');
        
        const profile = await liff.getProfile();
        
        logSuccess('âœ… liff.getProfile() ãŒæˆåŠŸã—ã¾ã—ãŸ');
        logInfo('User ID: ' + profile.userId);
        logInfo('Display Name: ' + (profile.displayName || '(æœªè¨­å®š)'));
        logInfo('Status Message: ' + (profile.statusMessage || '(æœªè¨­å®š)'));
        logInfo('Picture URL: ' + (profile.pictureUrl ? 'ã‚ã‚Š' : 'ãªã—'));
        
        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º
        if (profile.pictureUrl) {
          // URL ã®å½¢å¼ã‚’æ¤œè¨¼ï¼ˆhttps ã§å§‹ã¾ã‚‹ã“ã¨ã‚’ç¢ºèªï¼‰
          const isValidUrl = /^https:\/\/.+/.test(profile.pictureUrl);
          if (isValidUrl) {
            const debugSection = document.getElementById('debug-section');
            const imgSection = document.createElement('div');
            imgSection.style.marginTop = '16px';
            imgSection.style.textAlign = 'center';
            
            const p = document.createElement('p');
            p.style.marginBottom = '8px';
            p.style.color = '#666';
            p.textContent = 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ:';
            
            const img = document.createElement('img');
            img.src = profile.pictureUrl;
            img.alt = 'Profile';
            img.style.width = '100px';
            img.style.height = '100px';
            img.style.borderRadius = '50%';
            img.style.border = '2px solid #06c755';
            
            imgSection.appendChild(p);
            imgSection.appendChild(img);
            debugSection.appendChild(imgSection);
          } else {
            logWarn('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒURLã®å½¢å¼ãŒç„¡åŠ¹ã§ã™');
          }
        }
        
        // ãƒ‡ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸ ID ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ï¼ˆoptionalï¼‰
        try {
          const idToken = liff.getDecodedIDToken();
          if (idToken) {
            logInfo('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
            logInfo('ğŸ” ID Token æƒ…å ±');
            logInfo('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
            logInfo('Name: ' + (idToken.name || 'N/A'));
            logInfo('Email: ' + (idToken.email || 'N/A'));
            logInfo('Sub: ' + idToken.sub);
          }
        } catch (e) {
          logWarn('ID Token å–å¾—ã‚’ã‚¹ã‚­ãƒƒãƒ— (å–å¾—ã§ããªã„ç’°å¢ƒ)');
        }
        
        // æˆåŠŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
        updateStatus('âœ… ã™ã¹ã¦ã®ç¢ºèªãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
        logSuccess('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        logSuccess('PoC æ¤œè¨¼å®Œäº†ï¼');
        logSuccess('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        
        // å—ã‘å…¥ã‚Œæ¡ä»¶ã®ç¢ºèªçµæœã‚’è¡¨ç¤º
        logInfo('');
        logInfo('ğŸ“‹ å—ã‘å…¥ã‚Œæ¡ä»¶ãƒã‚§ãƒƒã‚¯:');
        logInfo('âœ“ liff.isInClient() = ' + isInClient);
        logInfo('âœ“ liff.init() ãŒ resolve ã—ãŸ');
        logInfo('âœ“ liff.getProfile() ãŒæˆåŠŸã—ãŸ');
        logInfo('âœ“ displayName: ' + (profile.displayName || '(æœªè¨­å®š)'));
        logInfo('âœ“ userId: ' + profile.userId);
        
      } catch (error) {
        updateStatus('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
        logError('ã‚¨ãƒ©ãƒ¼: ' + error.message);
        logError('Stack: ' + (error.stack || 'N/A'));
        console.error('LIFF Error:', error);
        
        // ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã«å¿œã˜ãŸãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        if (error.message.includes('endpoint')) {
          logError('');
          logError('ğŸ’¡ Endpoint URL ã®ä¸ä¸€è‡´ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™');
          logError('LINE Developers Console ã§è¨­å®šã—ãŸ Endpoint URL ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
          logError('Endpoint URL ã¯ã“ã®ãƒšãƒ¼ã‚¸ã® URL ã¨ä¸€è‡´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
        }
      }
    }
    
    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å®Ÿè¡Œ
    if (typeof liff !== 'undefined') {
      document.addEventListener('DOMContentLoaded', main);
    } else {
      document.addEventListener('DOMContentLoaded', function() {
        updateStatus('âŒ LIFF SDK ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
        logError('LIFF SDK ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        logError('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„');
      });
    }
  </script>
</body>
</html>
