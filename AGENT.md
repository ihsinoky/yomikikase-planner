# AGENT.md

このリポジトリで開発を行うエージェント（GitHub Copilot や将来の人間開発者）向けのガイドです。  
プロジェクトの目的・方針・開発ルールをここにまとめます。

---

## プロジェクトの目的

幼稚園の「絵本読み聞かせ」活動を支援する LINE ミニアプリ＋管理 Web アプリを開発する。

- 保護者は LINE ミニアプリから参加アンケートに回答できる
- 管理者は Web 画面からアンケート結果を確認し、確定日程・参加者を登録できる
- 個人に紐づくデータは年度単位で完結させる
- 絵本（ISBN ベース）の履歴は長期的に残し、次の絵本選びに活用する

詳細は以下を参照：
- `README.md`
- `RequirementSpecification.md`
- `ArchitectureDesign.md`
- `Milestone.md`

---

## 開発方針

### 1. TDD（テスト駆動開発）を基本とする

- 可能な限り **テストを先に書く**（または少なくとも同じ PR 内で追加する）
- 新しい機能を追加するときは、以下の順番を推奨：
  1. 期待する振る舞いをテストで表現する
  2. 最小限の実装でテストを通す
  3. リファクタリングする（テストはグリーンのまま）
- バグ修正時も、再現テスト → 修正 → テストグリーン、の流れを守る

### 2. 小さな変更・小さな PR

- 1 つの PR / 1 つのコミットで解決する Issue は **できるだけ小さく**する
- Copilot やエージェントは、一気に大規模な変更を提案するのではなく、
  - 1 つの画面
  - 1 つの API
  - 1 つのテーブル
  など、単位を絞ってコードを生成することを推奨

### 3. 読みやすさ優先

- ロジックが複雑になる場合は、名前付きの関数やドメインサービスに切り出す
- コメントは「なぜそうしているか」を書く  
  （「何をしているか」はコードと型で読み取れる状態が理想）

---

## 技術スタックの方針

※実装時に多少変えてもよいが、その場合は AGENT.md を更新すること。

- 言語: TypeScript
- フロントエンド:
  - 管理画面: Next.js（React + TypeScript）
  - LIFF ミニアプリ: Next.js 内に `/liff` 的なエントリを持たせる方針
- バックエンド:
  - Next.js の API Routes または独立した Node.js + Express/Fastify
  - 当面はモノリポ構成（1つのリポジトリに全部入れる）
- DB:
  - PostgreSQL を想定
  - Prisma を ORマッパ／マイグレーションツールとして使用予定
- テスト:
  - 単体テスト: Jest または Vitest（どちらかに決定）
  - フロントエンドコンポーネント: Testing Library
  - API 層: Supertest（または Next.js のテストユーティリティ）

---

## テストポリシー

- `src/**/__tests__/**/*.test.ts` もしくは `*.spec.ts` 形式でテストを書く
- CI では最低限以下を実行する：
  - `npm run lint`
  - `npm run test`
  - `npm run build`（将来追加）

### テストを書く優先度

1. ドメインロジック（集計・フィルタ・バリデーション）
2. API レイヤー（リクエスト/レスポンスの形）
3. フロントエンド（重要な画面の基本フロー）

UI の細かい見た目よりも、「正しいデータが扱われるか」を優先してテストする。

---

## CI / CD 方針

- GitHub Actions を用いた CI を使用する
- `main` / `develop` ブランチ（運用方針により決める）への PR は、以下がすべて通ること：
  - Lint
  - Test
  - Build
- 今のところ自動デプロイ（CD）は必須ではないが、将来的に追加しやすい構成を目指す

---

## コーディング規約

- フォーマッタ: Prettier
- Lint: ESLint（TypeScript 推奨設定＋React ルール）
- import順などは ESLint + Prettier に従う
- 命名規則:
  - TypeScript: `camelCase`
  - React コンポーネント / クラス: `PascalCase`
  - 定数: `UPPER_SNAKE_CASE`（必要な場合）

---

## Copilot / 自動エージェント向けガイドライン

- このファイルと `RequirementSpecification.md` を優先的に参照し、  
  「何をやっているリポジトリか」「どこまでがスコープか」を理解した上でコードを生成すること
- 一度に大量のファイルを変更しないこと（レビューしづらくなる）
- 型定義（TypeScript）を積極的に利用し、`any` を極力避ける
- 迷った場合は、ドメイン知識に近いロジックを先にテストで表現する

---

## ブランチ運用（暫定）

- `main`: 動くものだけが入るブランチ（本番相当）
- `develop`（必要なら）: 開発用メインブランチ
- Feature ブランチ:
  - 名前例: `feature/survey-list`, `feature/liff-profile`
- バグ修正:
  - 名前例: `fix/survey-csv-export`

ブランチ運用ルールを変えた場合は、ここを更新すること。

---

## PRレビュー / コードレビュー（Copilot coding agent 向け）

- コメントは日本語で記述すること

### 0) レビューの前提（一次ソース）
- スプリントの仕様・用語定義・決定事項は `docs/sprints/SPRINT_XX.md` を一次ソースとして参照すること。
  - Issue/PR本文と矛盾がある場合は、Docs を正として **Issue/PR本文（説明）を更新**し、実装・レビューも Docs 準拠で進めること。
- 「どのIssue/スプリントのゴールに紐づくPRか」を最初に特定してからレビューすること（スコープ逸脱を防ぐ）。

### 1) コンポーネントの責務を踏まえてレビューすること（必須）
- 変更対象が属するレイヤ/責務を明確にしてからレビューすること。
  - 例: UI/ページ責務（`src/pages/` 等）にドメインロジックを過剰に押し込まない
  - 例: 再利用可能なロジックは `src/lib/` 等へ寄せる
  - 例: データ取り込み/変換などの運用系は `scripts/` や `data/` の責務を尊重する
- レビュー観点（最低限）:
  - 変更が「そのコンポーネントであるべき理由」があるか（責務の逸脱がないか）
  - 境界（UI/ロジック/データ）を跨ぐ変更が必要以上に広がっていないか
  - 既存の依存方向（例: pages -> lib）を壊していないか
  - “ついで改修”で責務が混線していないか（必要ならバックログへ）

### 2) スプリントのゴールを踏まえてレビューすること（必須）
- そのスプリントのゴール/AC（受け入れ条件）に照らして、以下を必ずコメントすること:
  - 何が「ゴール達成」に寄与しているか
  - ゴール/AC に対して不足している点は何か
  - 逆に、スプリントスコープ外の変更が混入していないか（混入している場合は分離を提案）
- “良いが今やらない”改善案は、原則として **バックログ化**してスプリントのスコープを守る。

### 3) バックログを追加する場合は docs/BACKLOG.md に追記すること（必須）
- レビューの結果、新規の改善タスク/追加要件/技術負債返済が必要だと判断した場合:
  - **実装に混ぜない**（スプリントゴールを毀損しやすい）
  - `docs/BACKLOG.md` に追記すること（既存フォーマットがある場合はそれに従う）
- 追記内容の最低要件:
  - 目的（なぜ必要か）
  - 期待効果（ユーザー価値 or 開発効率/品質）
  - 完了条件（ざっくりで良い）
  - 参照（関連Issue/PR番号、該当コード領域）

### 4) レビューコメントの型（推奨テンプレ）
- Summary: 変更の要点（1〜3行）
- Sprint alignment: ゴール/ACとの整合（OK/NGと根拠）
- Responsibility check: コンポーネント責務の観点（OK/懸念点）
- Risks & tests: リスク、テスト/動作確認観点、再現手順
- Backlog: スコープ外だが価値がある提案（ある場合のみ。追記済みならその旨も記載）

---

## TODO（この AGENT.md 自体の今後）

- 実際にスタックが決まったら、テストツールやコマンド名を具体化する
- CI 設定（GitHub Actions）と連動する形で、コマンド名を揃える
- コントリビュート規約（CONTRIBUTING.md）が必要になったら分離する
